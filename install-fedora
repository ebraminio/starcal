#!/bin/bash
## makes rpm package and installs it using yum
set -e

## yum install @development-tools
## yum install rpm-build rpmdevtools rpmlint mock


if [ "$UID" != "0" ] ; then
	echo "Run this script as root" >&2
	exit 1
fi

if ! git --version ; then
	if ! dnf install git-core ; then
		echo -e "\n\nPlease install git and try again" >&2
		exit 1
	fi
fi


pyCmd=
for minor in 9 8 7 6 ; do
	cmd="/usr/bin/python3.$minor"
	if [ -f "$cmd" ] ; then
		pyCmd="$cmd"
		break
	fi
done
if [ -z "$pyCmd" ] ; then
	echo "Please install python3.9 and try again (or older down to python3.6)" >&2
	exit 1
fi
echo "Using python: \"$pyCmd\""

if ! which rpmbuild ; then
	if which dnf ; then
		dnf install rpm-build
	elif which yum ; then
		yum install rpm-build
	else
		echo "No 'dnf' nor 'yum' commands were found" >&2
		exit 1
	fi
fi

myPath=$(realpath "$0")

pkgName=starcal3
iconName=starcal32.png

sourceDir="`dirname \"$myPath\"`"
#"$sourceDir/scripts/assert_python3"
version=`"$sourceDir/scripts/version" | sed 's/\-/_/g'`

#echo "myPath=$myPath"
#echo "sourceDir=$sourceDir"
#echo version=$version

outDir="$HOME/.${pkgName}/pkgs/fedora/`/bin/date +%F-%H%M%S`"
mkdir -p "$outDir"

"$sourceDir/pkg/fedora/build.sh" "$outDir" "$pyCmd"
pkgPath=`ls -1 "$outDir"/*.rpm | tail -n1`

if [ ! -f $pkgPath ] ; then
	echo "rpmbuild exited with success status $status, but no package file was found" >&2
	exit 1
fi

echo "Package created in \"$pkgPath\", installing"
dnf remove -y $pkgName >/dev/null 2>&1 || true
dnf install --nogpgcheck "$pkgPath"
#rpm -U --force "$pkgPath" ## its OK when required packages are installed!

