#!/bin/bash
## makes PKGUILD and builds it (without root access), then installs it (prompts for password if necessary)
set -e

initPwd=$PWD

if ! git --version ; then
	if ! sudo pacman -S git ; then
		echo -e "\n\nPlease install git and try again" >&2
		exit 1
	fi
fi


myPath=$(realpath "$0")

pkgName=starcal3
sourceDir="`dirname \"$myPath\"`"
#"$sourceDir/scripts/assert_python3"
version=`"$sourceDir/scripts/version" | sed 's/\-/_/g'`

#echo "myPath=$myPath"
#echo "sourceDir=$sourceDir"
#echo version=$version

outDir="$HOME/.${pkgName}/pkgs/archlinux/`/bin/date +%F-%H%M%S`"
mkdir -p "$outDir"

pyCmd=$(ls -1 /usr/bin/python3.? | tail -n1)
if [ -z "$pyCmd" ] ; then
	echo "Could not find python3.x binary" >&2
	exit 1
fi
echo "Using python: \"$pyCmd\""

"$sourceDir/pkg/archlinux/build.sh" "$outDir" "$pyCmd"
pkgPath=`ls -1 "$outDir"/*.pkg.tar* | tail -n1`

sudo pacman -U "$pkgPath"

cd "$initPwd"
